# Example conversion to old conda-build format
# This would need to replace recipe.yaml for conda-build to work

{% set version = environ.get('RAPIDS_PACKAGE_VERSION', '0.0.0') %}
{% set py_version = environ.get('RAPIDS_PY_VERSION', '3.11') %}
{% set date_string = environ.get('RAPIDS_DATE_STRING', '000000') %}

package:
  name: cuvs-bench-cpu
  version: {{ version }}

source:
  path: ../../..

build:
  string: py{{ py_version }}_{{ date_string }}
  script: |
    set -x
    export CFLAGS=$(echo $CFLAGS | sed -E 's@\-fdebug\-prefix\-map[^ ]*@@g')
    export CXXFLAGS=$(echo $CXXFLAGS | sed -E 's@\-fdebug\-prefix\-map[^ ]*@@g')
    set +x
    
    ./build.sh bench-ann --cpu-only --no-nvtx --build-metrics=bench_ann_cpu --incl-cache-stats
    cmake --install cpp/build --component ann_bench

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - cmake >=3.30.4
    - ninja
    - {{ stdlib("c") }}
  host:
    - benchmark
    - glog >=0.6.0
    - nlohmann_json >=3.12.0
    - openblas
    - pip
    - python ={{ py_version }}
    - rapids-build-backend>=0.4.0,<0.5.0.dev0
    - setuptools >=64.0.0
    - libaio  # [linux64]
    - libboost-devel=1.87  # [linux64]
    - mkl-devel=2023  # [linux64]
  run:
    - benchmark
    - click
    - glog >=0.6.0
    - h5py >=3.8.0
    - matplotlib-base>=3.9
    - numpy >=1.23,<3.0a0
    - pandas
    - pyyaml
    - python
    - requests
    - scikit-learn>=1.5
    - libaio  # [linux64]
    - mkl =2023  # [linux64]

test:
  imports:
    - cuvs_bench
    - cuvs_bench.generate_groundtruth
    - cuvs_bench.get_dataset
    - cuvs_bench.plot
    - cuvs_bench.run
    - cuvs_bench.split_groundtruth

about:
  home: https://github.com/rapidsai/cuvs
  license: Apache-2.0
  summary: cuVS CPU benchmark
